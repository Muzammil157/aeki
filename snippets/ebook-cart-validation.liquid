<script>
(function() {
  const EBOOK_HANDLE = 'e-book-tutorial';
  let ebookVariantId = null;

  // Get ebook variant ID
  fetch('/products/' + EBOOK_HANDLE + '.js')
    .then(response => response.json())
    .then(ebookProduct => {
      ebookVariantId = ebookProduct.variants[0].id;
      checkAndRemoveEbookIfAlone();
    })
    .catch(error => {
      console.error('Error fetching ebook product:', error);
    });

  function checkAndRemoveEbookIfAlone() {
    if (!ebookVariantId) return;

    fetch('/cart.js')
      .then(response => response.json())
      .then(cart => {
        // Check if ebook is the only item in cart
        if (cart.item_count === 1 && cart.items[0].variant_id === ebookVariantId) {
          // Remove the ebook
          fetch('/cart/change.js', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              id: ebookVariantId,
              quantity: 0
            })
          })
          .then(response => response.json())
          .then(data => {
            // Reload the page to show empty cart
            window.location.reload();
          })
          .catch(error => {
            console.error('Error removing ebook:', error);
          });
        } else if (cart.item_count > 1) {
          // Check if ebook exists without the main product
          const hasEbook = cart.items.some(item => item.variant_id === ebookVariantId);
          const hasMainProduct = cart.items.some(item => item.product_id === 56877546209667);

          if (hasEbook && !hasMainProduct) {
            // Remove ebook if main product is not in cart
            fetch('/cart/change.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id: ebookVariantId,
                quantity: 0
              })
            })
            .then(response => response.json())
            .then(data => {
              window.location.reload();
            })
            .catch(error => {
              console.error('Error removing ebook:', error);
            });
          }
        }
      })
      .catch(error => {
        console.error('Error fetching cart:', error);
      });
  }

  // Run validation on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkAndRemoveEbookIfAlone);
  } else {
    checkAndRemoveEbookIfAlone();
  }

  // Listen for cart updates
  document.addEventListener('cart:updated', function() {
    setTimeout(checkAndRemoveEbookIfAlone, 500);
  });

  // Listen for cart drawer updates
  if (window.theme && window.theme.cart) {
    const originalUpdate = window.theme.cart.update;
    if (originalUpdate) {
      window.theme.cart.update = function() {
        originalUpdate.apply(this, arguments);
        setTimeout(checkAndRemoveEbookIfAlone, 500);
      };
    }
  }
})();
</script>
